# 领域建模

对于简单的业务领域，一个领域可能就是一个小的子域。领域建模过程相对简单，根据事件风暴可以分解出事件、命令、实体、聚合和限界上下文等，根据领域模型和微服务拆分原则设计出微服务即可。对于复杂的业务领域，领域可能还需要拆分为子域，甚至子域还会进一步拆分，如：保险领域可以拆分为承保、理赔、收付费和再保等子域，承保子域还可以再拆分为投保、保单管理等子子域。对于这种复杂的领域模型，是无法通过一个事件风暴完成领域建模的，即使能完成，其工程量也是非常浩大，效果也不一定好。

对于这种复杂的领域，我们可以分三阶段来完成领域模型和微服务设计。

- 拆分子域建立领域模型：根据业务特点考虑流程节点或功能模块等边界因素（微服务最终的拆分结果很多时候跟这些边界因素有一定的相关性），按领域逐级分解为大小合适的子域，针对子域进行事件风暴，记录领域对象、聚合和限界上下文，初步确定各级子域的领域模型。

- 领域模型微调：梳理领域内所有子域的领域模型，对各子域模型进行微调，这个过程重点考虑不同限界上下文内聚合的重新组合，同步需要考虑子域、限界上下文以及聚合之间的边界、服务以及事件之间的依赖关系，确定最终的领域模型。

- 微服务设计和拆分：根据领域模型的限界上下文和微服务的拆分原则，完成微服务的拆分和设计。

# 用例分析与关系推导

我们经过对一个业务过程总是可以识别出有哪些人、角色会参与到业务过程的相关活动中，我们使用 UML 建模方法。一般我们会用 Use Case 图进行表达，Use Case 图会包含这些元素：

- Actor：常见的翻译包括“参与者、执行者、主角”等等。
- Use Case：在不展现一个系统或子系统内部结构的情况下，对系统或子系统的某个连贯的功能单元的定义和描述。

其中 Use Case 还会包含这些信息：名称、简单描述、关系、活动图和状态图、前置条件、后置条件等等。以一个简单的用户账号管理为例，我们绘制的整体 Use Case 图如下：

![](https://i.postimg.cc/q7chY3SD/image.png)

比如让你设计一个中介系统，一个典型的 User Story 可能是“小明去找工作，中介说你留个电话，有工作机会我会通知你”，这里面的关键名词很可能就是我们需要的领域对象：

- 小明是求职者。
- 电话是求职者的属性。
- 中介包含了中介公司，中介员工两个关键对象。
- 工作机会肯定也是关键领域对象；
- 通知这个动词暗示我们这里用观察者模式会比较合适。

然后再梳理一下领域对象之间的关系，一个求职者可以应聘多个工作机会，一个工作机会也可以被多个求职者应聘，M2M 的关系，中介公司可以包含多个员工，O2M 的关系。对于这样简单的场景，这个建模就差不多了。

譬如典型的银行转账的案例中，商户从自己的 MPA 账户转出 1 美元给用户余额账户。其他的业务描述还包括： 商户转账可以透支，但转账金额不能超出可用金额；转账将向商家收取一定费用；商户或用户都必须是正常状态。

## 词法分析

分析用例句子中的词语及词性，提取句中的名词，找出业务主体。参考的词性列举如下：

![](https://i.postimg.cc/xdFxd6zr/image.png)

譬如上述描述中的名词有：

- 商户：资金流出方
- 账户：MPA 账户和余额账户
- 用户：资金流入方
- 金额：100 美元，由量词和单位组成
- 订单：资金业务单据
- 单位（币种）：和数量词共同组成金额

## 句法分析

分析用例句子中词语的关系，构建业务主体关系。参考的句法：

![](https://i.postimg.cc/1XxZ8mqZ/image.png)

- 商户拥有 MAP 账户
- 账户被商户与用户拥有
- 用户拥有余额账户
- 订单拥有金额
- 金额由数据及单位组成
- 账户拥有多个类型

基于此我们可以去建立业务主体间的关系：

![](https://i.postimg.cc/xTGDxVW6/image.png)

# 域划分设计

在进行业务架构设计时，我们需要进行业务域的划分。能否划分出合理、稳定、可持续发展的业务域对于未来平台的发展可谓至关重要。通过事件风暴建立领域模型，合理划分领域逻辑和物理边界，建立领域对象及服务矩阵和服务架构图，定义符合 DDD 分层架构思想的代码结构模型，保证业务模型与代码模型的一致性。通过上述设计思想、方法和过程，指导团队按照 DDD 设计思想完成微服务设计和开发。梳理业务事件，然后将领域对象、业务事件，根据创建者、单一职责、高内聚和松耦合进行归纳分类，最终确定领域边界。

## 鲁棒图

鲁棒图是需求设计过程中使用的一种方法（鲁棒性分析），通过鲁棒分析法可以让设计人员更清晰、全面了解需求。它通常使用在需求分析后及需求设计前做软件架构分析之用，它主要注重于功能需求的设计分析工作。需求规格说明书为其输入信息，设计模型为其输出信息。它是从功能需求向设计方案过渡的第一步，重点是识别组成软件系统的高级职责模块、规划模块之间的关系。

鲁棒图包含三种图形：边界、控制、实体，三个图形如下：

![](https://i.postimg.cc/zB0LD1Jn/image.png)

- 边界：起与外界交互的作用，它只能与控制对象和执行者有关系
- 控制：对业务控制、流程控制的作用，它能与边界对象和实体对象有关系
- 实体：业务元素的存储对象，与领域模型中的对象有良好的关系。它只能与控制对象有关系

我们在对之前识别出的每个 Use Case，都可以绘制一份鲁棒图。通过绘制鲁棒图，我们可以定义出该场景的涉及到的边界类、控制类以及这些控制类会加工/处理哪些实体对象。我们以邮箱注册账号这个 Case 为例，我们可以简单的绘制出鲁棒图如下：

![](https://i.postimg.cc/dVrLkCsQ/image.png)

## 领域划分

接下来，我们通过对所有实体对象进行分类，就可以完成域划分了。比如，主订单、子订单对象可以归类到交易域；买家、卖家对象可以归类到商户域等：

![](https://i.postimg.cc/CLy2Dr6S/image.png)

先行分析实体与事件关系，如下：

- 订单：创建、付款、收款、关单、撤销、退款、查询、充转提
- 商户、用户：查询、鉴权、注册
- 产品：签约、制定计收费规划

![](https://i.postimg.cc/fbr6tz9R/image.png)

当然，最终所有的对象是归类到十个域还是二十个域，从理论上看，可以看做一次排列组合过程。只是，我们往往可以根据以往的经验、业务知识，做一个初始的域划分（但不见得是靠谱的）。因此，我们可以认为一个域实际上是一个或多个实体对象的信息集合，并对所管理的实体对象的生命周期进行管理。

- 一个域管理一个或多个实体对象
- 一个实体对象被一个域进行管理
- 如果出现一个实体对象被多个域进行管理，那么相关域的职责实际上就是存在冲突，存在耦合，相互影响。

比如在 CRM 领域，我们按照下面的战略设计图，我会自然的把 CRM 系统划分成销售服务，组织权限服务，营销服务，售卖服务：

![](https://i.postimg.cc/R055KqkF/image.png)

## 域划分评估

在领域划分之后往往可以得到一个或多个域划分的方案（或者组合），接下来就是判断哪种划分方案更为合理。主要的判定原则会参照经典的“高内聚、低耦合”的原则，即将绘制每个 Use Case 的时序图，并以域为维度来绘制生命周期线，看域与域之间的调用是否过于频繁？甚至是反复调用不同的域服务？如果存在这种情况，就意味着这两个域之间存在比较严重的耦合。这往往通过直观就能有个大致的判断。如果要从定量角度来分析，可以参考代码圈复杂度的度量算法，我们也可以设定一个“域依赖度”算法，来衡量域与域之间的依赖度。对于依赖度比较高的几个域，我们可以采用：域合并，域拆分或者提取第三方域做依赖倒置等降低耦合。

![](https://i.postimg.cc/MTQWN2n6/image.png)

通过将所有的 Use Case（至少是最关键的一级 Case）绘制完时序图后，我们基本上就可以得到一个经过平衡考量后合理的域划分。
